<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestión de Reservas</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <section>
      <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
          <a class="navbar-brand" href="main_menu.html">Mi Clínica</a>
          <button
            class="navbar-toggler"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#navbarNav"
            aria-controls="navbarNav"
            aria-expanded="false"
            aria-label="Toggle navigation"
          >
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
              <li class="nav-item">
                <a class="nav-link" href="doctors_menu.html">Doctores</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="health_insurances_menu.html"
                  >Obras sociales</a
                >
              </li>
              <li class="nav-item">
                <a class="nav-link" href="specialties_menu.html"
                  >Especialidades</a
                >
              </li>
              <li class="nav-item">
                <a class="nav-link" href="appointments_menu.html">Turnos</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="reservations_menu.html">Reservas</a>
              </li>
            </ul>
          </div>
        </div>
      </nav>
    </section>

    <div class="container py-4">
      <header
        class="d-flex justify-content-between align-items-center flex-wrap mb-4"
      >
        <h1 class="mb-2 mb-md-0">Reservas</h1>
        <div class="d-flex gap-2 flex-wrap">
          <button id="btnNuevo" class="btn btn-primary">Nueva Reserva</button>
          <button
            id="btnToggleView"
            class="btn btn-secondary d-none d-md-block"
          >
            Cambiar Vista
          </button>
        </div>
      </header>

      <!-- Grid de reservas -->
      <div id="gridContainer" class="row row-cols-1 row-cols-md-3 g-3"></div>

      <!-- Tabla de reservas -->
      <div id="tableContainer" class="table-responsive d-none">
        <table class="table table-striped table-bordered align-middle">
          <thead class="table-dark">
            <tr>
              <th>DNI</th>
              <th>Paciente</th>
              <th>Médico</th>
              <th>Especialidad</th>
              <th>Obra Social</th>
              <th>Turno</th>
              <th>Monto Total</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="modalReserva" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="modalTitle">Nueva Reserva</h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Cerrar"
            ></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="reservaId" />
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">DNI</label>
                <input type="number" class="form-control" id="dni" />
              </div>
              <div class="col-md-8">
                <label class="form-label">Nombre del Paciente</label>
                <input type="text" class="form-control" id="patientName" />
              </div>
              <div class="col-md-4">
                <label class="form-label">Especialidad</label>
                <select id="specialtySelect" class="form-select"></select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Médico</label>
                <select id="doctorSelect" class="form-select"></select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Obra Social</label>
                <select id="insuranceSelect" class="form-select"></select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Turno</label>
                <select id="appointmentSelect" class="form-select"></select>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button type="button" class="btn btn-primary" id="guardarReserva">
              Guardar
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const API_BASE = "http://localhost:3000/api";

      const gridContainer = document.getElementById("gridContainer");
      const tableContainer = document.getElementById("tableContainer");
      const tableBody = document.getElementById("tableBody");
      const modalElement = document.getElementById("modalReserva");
      const modal = new bootstrap.Modal(modalElement);
      const btnNuevo = document.getElementById("btnNuevo");
      const btnToggleView = document.getElementById("btnToggleView");
      const guardarBtn = document.getElementById("guardarReserva");

      const specialtySelect = document.getElementById("specialtySelect");
      const doctorSelect = document.getElementById("doctorSelect");
      const insuranceSelect = document.getElementById("insuranceSelect");
      const appointmentSelect = document.getElementById("appointmentSelect");

      let reservas = [];
      let specialties = [];
      let doctors = [];
      let insurances = [];
      let appointments = [];
      let reservaEditando = null;
      let gridView = true;

      // ---------- FETCH ----------
      async function fetchData() {
        [specialties, doctors, insurances, appointments, reservas] =
          await Promise.all([
            fetch(`${API_BASE}/specialties`).then((r) => r.json()),
            fetch(`${API_BASE}/doctors`).then((r) => r.json()),
            fetch(`${API_BASE}/healthinsurances`).then((r) => r.json()),
            fetch(`${API_BASE}/appointments`).then((r) => r.json()),
            fetch(`${API_BASE}/reservations`).then((r) => r.json()),
          ]);
        renderSelects();
        renderReservas();
      }

      // ---------- RENDER ----------
      function renderSelects() {
        specialtySelect.innerHTML = specialties
          .map((s) => `<option value="${s._id}">${s.name}</option>`)
          .join("");
        doctorSelect.innerHTML = doctors
          .map(
            (d) =>
              `<option value="${d._id}">${d.firstName} ${d.lastName}</option>`,
          )
          .join("");
        insuranceSelect.innerHTML = insurances
          .map((i) => `<option value="${i._id}">${i.name}</option>`)
          .join("");
        appointmentSelect.innerHTML = appointments
          .filter((a) => a.available)
          .map(
            (a) =>
              `<option value="${a._id}">${new Date(a.dateTime).toLocaleString()}</option>`,
          )
          .join("");
      }

      function renderReservas() {
        if (window.innerWidth < 768) gridView = true;

        if (gridView) {
          tableContainer.classList.add("d-none");
          gridContainer.classList.remove("d-none");
          gridContainer.innerHTML = reservas.length
            ? reservas
                .map(
                  (r) => `
            <div class="col">
              <div class="card h-100 shadow-sm">
                <div class="card-body">
                  <h5 class="card-title">${r.patientName}</h5>
                  <p class="mb-1">DNI: ${r.dni}</p>
                  <p class="mb-1">Médico: ${r.doctor?.firstName} ${r.doctor?.lastName}</p>
                  <p class="mb-1">Especialidad: ${r.specialty?.name}</p>
                  <p class="mb-1">Obra Social: ${r.healthInsurance?.name}</p>
                  <p class="mb-1">Turno: ${new Date(r.appointment?.dateTime).toLocaleString()}</p>
                  <p class="mb-1">Monto Total: $${r.totalAmount}</p>
                  <div class="d-flex justify-content-end gap-2 mt-2">
                    <button class="btn btn-sm btn-outline-primary editar-btn" data-id="${r._id}">Editar</button>
                    <button class="btn btn-sm btn-outline-danger eliminar-btn" data-id="${r._id}">Eliminar</button>
                  </div>
                </div>
              </div>
            </div>
          `,
                )
                .join("")
            : `<div class="text-muted">No hay reservas</div>`;
        } else {
          gridContainer.classList.add("d-none");
          tableContainer.classList.remove("d-none");
          tableBody.innerHTML = reservas.length
            ? reservas
                .map(
                  (r) => `
            <tr>
              <td>${r.dni}</td>
              <td>${r.patientName}</td>
              <td>${r.doctor?.firstName} ${r.doctor?.lastName}</td>
              <td>${r.specialty?.name}</td>
              <td>${r.healthInsurance?.name}</td>
              <td>${new Date(r.appointment?.dateTime).toLocaleString()}</td>
              <td>$${r.totalAmount}</td>
              <td>
                <button class="btn btn-sm btn-outline-primary editar-btn" data-id="${r._id}">Editar</button>
                <button class="btn btn-sm btn-outline-danger eliminar-btn" data-id="${r._id}">Eliminar</button>
              </td>
            </tr>
          `,
                )
                .join("")
            : `<tr><td colspan="8" class="text-center text-muted">No hay reservas</td></tr>`;
        }

        document.querySelectorAll(".editar-btn").forEach((btn) => {
          btn.addEventListener("click", () =>
            abrirModalEditar(reservas.find((r) => r._id === btn.dataset.id)),
          );
        });
        document.querySelectorAll(".eliminar-btn").forEach((btn) => {
          btn.addEventListener("click", async () => {
            if (!confirm("¿Eliminar reserva?")) return;
            await fetch(`${API_BASE}/reservations`, {
              method: "DELETE",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ id: btn.dataset.id }),
            });
            await fetchData();
          });
        });
      }

      // ---------- MODAL ----------
      btnNuevo.addEventListener("click", abrirModalNuevo);
      function abrirModalNuevo() {
        reservaEditando = null;
        document.getElementById("modalTitle").textContent = "Nueva Reserva";
        document.getElementById("reservaId").value = "";
        document.getElementById("dni").value = "";
        document.getElementById("patientName").value = "";
        specialtySelect.value = specialties[0]?._id || "";
        doctorSelect.value = doctors[0]?._id || "";
        insuranceSelect.value = insurances[0]?._id || "";
        appointmentSelect.value =
          appointments.find((a) => a.available)?._id || "";
        modal.show();
      }

      function abrirModalEditar(r) {
        reservaEditando = r;
        document.getElementById("modalTitle").textContent = "Editar Reserva";
        document.getElementById("reservaId").value = r._id;
        document.getElementById("dni").value = r.dni;
        document.getElementById("patientName").value = r.patientName;
        specialtySelect.value = r.specialty?._id || "";
        doctorSelect.value = r.doctor?._id || "";
        insuranceSelect.value = r.healthInsurance?._id || "";
        appointmentSelect.value = r.appointment?._id || "";
        modal.show();
      }

      // ---------- GUARDAR ----------
      guardarBtn.addEventListener("click", async () => {
        const data = {
          dni: Number(document.getElementById("dni").value),
          patientName: document.getElementById("patientName").value,
          specialty: specialtySelect.value,
          doctor: doctorSelect.value,
          healthInsurance: insuranceSelect.value,
          appointment: appointmentSelect.value,
        };

        try {
          let res;
          if (reservaEditando) {
            data.id = reservaEditando._id;
            res = await fetch(`${API_BASE}/reservations`, {
              method: "PATCH",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data),
            });
          } else {
            res = await fetch(`${API_BASE}/reservations`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data),
            });
          }
          if (!res.ok) {
            const error = await res.json();
            throw new Error(error.message || "Error guardando reserva");
          }
          await fetchData();
          modal.hide();
        } catch (err) {
          alert(err.message);
        }
      });

      // ---------- TOGGLE VISTA ----------
      btnToggleView.addEventListener("click", () => {
        gridView = !gridView;
        renderReservas();
      });
      window.addEventListener("resize", () => {
        if (window.innerWidth < 768) gridView = true;
        renderReservas();
      });

      // ---------- INIT ----------
      fetchData();
    </script>
  </body>
</html>
