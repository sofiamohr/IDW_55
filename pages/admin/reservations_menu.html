<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestión de Reservas - MedicalIDW</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
    />
    <style>
      .card-title {
        font-size: 1.1rem;
      }
      .nav-link.active {
        font-weight: 600;
        text-decoration: underline;
        color: #fff !important;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container-fluid">
        <a class="navbar-brand" href="/">Home Page</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="doctors_menu.html">Doctores</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="health_insurances_menu.html"
                >Obras sociales</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="specialties_menu.html"
                >Especialidades</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="appointments_menu.html">Turnos</a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="reservations_menu.html"
                >Reservas</a
              >
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container py-4">
      <header
        class="d-flex justify-content-between align-items-center flex-wrap mb-4"
      >
        <h1 class="mb-2 mb-md-0">Reservas</h1>
        <div class="d-flex gap-2 flex-wrap">
          <button id="btnNuevo" class="btn btn-success">
            <i class="bi bi-plus-circle"></i> Nueva Reserva
          </button>
          <div class="btn-group d-none d-md-flex">
            <button id="btnVistaTabla" class="btn btn-outline-primary">
              Tabla
            </button>
            <button id="btnVistaGrid" class="btn btn-outline-primary active">
              Grid
            </button>
          </div>
        </div>
      </header>

      <div
        id="gridContainer"
        class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3"
      ></div>
      <div id="tableContainer" class="table-responsive d-none">
        <table class="table table-striped table-bordered align-middle">
          <thead class="table-primary">
            <tr>
              <th>DNI</th>
              <th>Paciente</th>
              <th>Médico</th>
              <th>Especialidad</th>
              <th>Obra Social</th>
              <th>Turno</th>
              <th>Monto Total</th>
              <th class="text-center">Acciones</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>

    <div class="modal fade" id="modalReserva" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="modalTitle">Nueva Reserva</h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="reservaId" />
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">DNI</label>
                <input type="number" class="form-control" id="dni" />
              </div>
              <div class="col-md-8">
                <label class="form-label">Nombre del Paciente</label>
                <input type="text" class="form-control" id="patientName" />
              </div>
              <div class="col-md-4">
                <label class="form-label">Obra Social</label>
                <select id="insuranceSelect" class="form-select"></select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Especialidad</label>
                <select id="specialtySelect" class="form-select"></select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Fecha</label>
                <input type="date" class="form-control" id="dateInput" />
              </div>
              <div class="col-md-12">
                <label class="form-label">Turno</label>
                <select
                  id="appointmentSelect"
                  class="form-select"
                  disabled
                ></select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Monto Total</label>
                <div id="totalAmountDisplay" class="form-control bg-light">
                  --
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button type="button" class="btn btn-primary" id="guardarReserva">
              Guardar
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        const API_BASE = "http://localhost:3000/api";

        const gridContainer = document.getElementById("gridContainer");
        const tableContainer = document.getElementById("tableContainer");
        const tableBody = document.getElementById("tableBody");
        const modalElement = document.getElementById("modalReserva");
        const modal = new bootstrap.Modal(modalElement);
        const btnNuevo = document.getElementById("btnNuevo");
        const btnVistaTabla = document.getElementById("btnVistaTabla");
        const btnVistaGrid = document.getElementById("btnVistaGrid");
        const guardarBtn = document.getElementById("guardarReserva");

        const specialtySelect = document.getElementById("specialtySelect");
        const insuranceSelect = document.getElementById("insuranceSelect");
        const appointmentSelect = document.getElementById("appointmentSelect");
        const dniInput = document.getElementById("dni");
        const patientNameInput = document.getElementById("patientName");
        const totalAmountDisplay =
          document.getElementById("totalAmountDisplay");
        const reservaIdInput = document.getElementById("reservaId");
        const dateInput = document.getElementById("dateInput");

        let reservas = [],
          specialties = [],
          doctors = [],
          insurances = [],
          appointments = [];
        let reservaEditando = null;
        let vista = "grid";

        async function fetchData() {
          [specialties, doctors, insurances, appointments, reservas] =
            await Promise.all([
              fetch(`${API_BASE}/specialties`).then((r) => r.json()),
              fetch(`${API_BASE}/doctors`).then((r) => r.json()),
              fetch(`${API_BASE}/healthinsurances`).then((r) => r.json()),
              fetch(`${API_BASE}/appointments`).then((r) => r.json()),
              fetch(`${API_BASE}/reservations`).then((r) => r.json()),
            ]);
          renderSelects();
          renderReservas();
        }

        function renderSelects() {
          specialtySelect.innerHTML = specialties
            .map((s) => `<option value="${s._id}">${s.name}</option>`)
            .join("");
          insuranceSelect.innerHTML = insurances
            .map((i) => `<option value="${i._id}">${i.name}</option>`)
            .join("");
        }
        function filterAppointments() {
          const specialtyId = specialtySelect.value;
          const dateValue = dateInput.value;
          const insuranceId = insuranceSelect.value;

          if (!specialtyId || !dateValue || !insuranceId) {
            appointmentSelect.innerHTML = "";
            appointmentSelect.disabled = true;
            totalAmountDisplay.textContent = "--";
            return;
          }

          const filtered = appointments.filter((a) => {
            const sameDay = a.dateTime.slice(0, 10) === dateValue;
            console.log(a);
            const doctorHasSpecialty = a.doctor.specialty.includes(specialtyId);
            return a.available && sameDay && doctorHasSpecialty;
          });

          console.log("Appointments filtrados:", filtered); // Para verificar en la consola

          // Mostramos todas las opciones filtradas
          appointmentSelect.innerHTML = filtered
            .map((a) => {
              const doc = doctors.find((d) => d._id === a.doctor._id);
              return `<option value="${a._id}">${new Date(a.dateTime).toLocaleString()} - Dr. ${doc.firstName} ${doc.lastName}</option>`;
            })
            .join("");

          appointmentSelect.disabled = filtered.length === 0;

          calculateTotal();
        }
        function calculateTotal() {
          const appointmentId = appointmentSelect.value;
          if (!appointmentId) {
            totalAmountDisplay.textContent = "--";
            return;
          }
          const appointment = appointments.find((a) => a._id === appointmentId);
          const doctor = doctors.find((d) => d._id === appointment.doctor._id);
          const insurance = insurances.find(
            (i) => i._id === insuranceSelect.value,
          );
          const total =
            doctor.consultationFee * (1 - (insurance.discount || 0) / 100);
          totalAmountDisplay.textContent = `$${total.toFixed(2)}`;
        }

        specialtySelect.addEventListener("change", filterAppointments);
        insuranceSelect.addEventListener("change", filterAppointments);
        dateInput.addEventListener("change", filterAppointments);
        appointmentSelect.addEventListener("change", calculateTotal);

        function renderReservas() {
          if (window.innerWidth < 768) vista = "grid";
          if (vista === "grid") {
            tableContainer.classList.add("d-none");
            gridContainer.classList.remove("d-none");
            gridContainer.innerHTML = reservas.length
              ? reservas
                  .map(
                    (r) => `
                <div class="col">
                  <div class="card h-100 shadow-sm">
                    <div class="card-body">
                      <h5 class="card-title">${r.patientName}</h5>
                      <p class="mb-1">DNI: ${r.dni}</p>
                      <p class="mb-1">Médico: ${r.doctor?.firstName} ${r.doctor?.lastName}</p>
                      <p class="mb-1">Especialidad: ${r.specialty?.name}</p>
                      <p class="mb-1">Obra Social: ${r.healthInsurance?.name}</p>
                      <p class="mb-1">Turno: ${new Date(r.appointment?.dateTime).toLocaleString()}</p>
                      <p class="mb-1">Monto: $${r.totalAmount}</p>
                    </div>
                  </div>
                </div>
              `,
                  )
                  .join("")
              : `<div class="text-center text-muted py-4">No hay reservas</div>`;
          } else {
            gridContainer.classList.add("d-none");
            tableContainer.classList.remove("d-none");
            tableBody.innerHTML = reservas.length
              ? reservas
                  .map(
                    (r) => `
                <tr>
                  <td>${r.dni}</td>
                  <td>${r.patientName}</td>
                  <td>${r.doctor?.firstName} ${r.doctor?.lastName}</td>
                  <td>${r.specialty?.name}</td>
                  <td>${r.healthInsurance?.name}</td>
                  <td>${new Date(r.appointment?.dateTime).toLocaleString()}</td>
                  <td>$${r.totalAmount}</td>
                </tr>
              `,
                  )
                  .join("")
              : `<tr><td colspan="7" class="text-center text-muted">No hay reservas</td></tr>`;
          }
        }

        function abrirModalNuevo() {
          reservaEditando = null;
          document.getElementById("modalTitle").textContent = "Nueva Reserva";
          reservaIdInput.value = "";
          dniInput.value = "";
          patientNameInput.value = "";
          dateInput.value = "";
          specialtySelect.value = specialties[0]?._id || "";
          insuranceSelect.value = insurances[0]?._id || "";
          appointmentSelect.innerHTML = "";
          appointmentSelect.disabled = true;
          totalAmountDisplay.textContent = "--";
          modal.show();
        }

        guardarBtn.addEventListener("click", async () => {
          const data = {
            dni: Number(dniInput.value),
            patientName: patientNameInput.value,
            totalAmount: Number(
              totalAmountDisplay.textContent.replace("$", ""),
            ),
            specialty: specialtySelect.value,
            healthInsurance: insuranceSelect.value,
            appointment: appointmentSelect.value,
            doctor: doctors.find((d) =>
              d.specialty.some((s) => s._id === specialtySelect.value),
            )._id,
          };
          try {
            const res = await fetch(`${API_BASE}/reservations`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data),
            });
            if (!res.ok) throw new Error("Error guardando reserva");
            await fetchData();
            modal.hide();
          } catch (err) {
            alert(err.message);
          }
        });

        btnNuevo.addEventListener("click", abrirModalNuevo);

        btnVistaTabla.addEventListener("click", () => {
          vista = "tabla";
          btnVistaTabla.classList.add("active");
          btnVistaGrid.classList.remove("active");
          renderReservas();
        });
        btnVistaGrid.addEventListener("click", () => {
          vista = "grid";
          btnVistaGrid.classList.add("active");
          btnVistaTabla.classList.remove("active");
          renderReservas();
        });

        window.addEventListener("resize", () => {
          if (window.innerWidth < 768) vista = "grid";
          renderReservas();
        });

        await fetchData();
      });
    </script>
  </body>
</html>
