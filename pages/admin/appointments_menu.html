<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestión de Turnos</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <section>
      <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
          <a class="navbar-brand" href="main_menu.html">Mi Clínica</a>
          <button
            class="navbar-toggler"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#navbarNav"
            aria-controls="navbarNav"
            aria-expanded="false"
            aria-label="Toggle navigation"
          >
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
              <li class="nav-item">
                <a class="nav-link" href="doctors_menu.html">Doctores</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="health_insurances_menu.html"
                  >Obras sociales</a
                >
              </li>
              <li class="nav-item">
                <a class="nav-link" href="specialties_menu.html"
                  >Especialidades</a
                >
              </li>
              <li class="nav-item">
                <a class="nav-link" href="appointments_menu.html">Turnos</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="reservations_menu.html">Reservas</a>
              </li>
            </ul>
          </div>
        </div>
      </nav>
    </section>

    <div class="container py-4">
      <header
        class="d-flex justify-content-between align-items-center flex-wrap mb-4"
      >
        <h1 class="mb-2 mb-md-0">Turnos</h1>
        <div class="d-flex gap-2 flex-wrap">
          <button id="btnNuevo" class="btn btn-primary">Nuevo Turno</button>
          <button
            id="btnToggleView"
            class="btn btn-secondary d-none d-md-block"
          >
            Cambiar Vista
          </button>
        </div>
      </header>

      <!-- Grid de turnos -->
      <div id="gridContainer" class="row row-cols-1 row-cols-md-3 g-3"></div>

      <!-- Tabla de turnos -->
      <div id="tableContainer" class="table-responsive d-none">
        <table class="table table-striped table-bordered align-middle">
          <thead class="table-dark">
            <tr>
              <th>Médico</th>
              <th>Fecha/Hora</th>
              <th>Duración</th>
              <th>Disponible</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="modalTurno" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="modalTitle">Nuevo Turno</h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Cerrar"
            ></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="turnoId" />
            <div class="mb-3">
              <label class="form-label">Médico</label>
              <select id="doctorSelect" class="form-select"></select>
            </div>
            <div class="mb-3">
              <label class="form-label">Fecha y Hora</label>
              <input type="datetime-local" class="form-control" id="dateTime" />
            </div>
            <div class="mb-3">
              <label class="form-label">Duración (minutos)</label>
              <input
                type="number"
                class="form-control"
                id="durationMinutes"
                value="30"
                min="5"
                max="120"
              />
            </div>
            <div class="form-check">
              <input
                type="checkbox"
                class="form-check-input"
                id="available"
                checked
              />
              <label class="form-check-label" for="available">Disponible</label>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button type="button" class="btn btn-primary" id="guardarTurno">
              Guardar
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const API_TURNOS = "http://localhost:3000/api/appointments";
      const API_DOCTORES = "http://localhost:3000/api/doctors";

      const gridContainer = document.getElementById("gridContainer");
      const tableContainer = document.getElementById("tableContainer");
      const tableBody = document.getElementById("tableBody");
      const doctorSelect = document.getElementById("doctorSelect");
      const modalElement = document.getElementById("modalTurno");
      const modal = new bootstrap.Modal(modalElement);
      const btnNuevo = document.getElementById("btnNuevo");
      const btnToggleView = document.getElementById("btnToggleView");
      const guardarBtn = document.getElementById("guardarTurno");

      let turnos = [];
      let doctors = [];
      let turnoEditando = null;
      let gridView = true;

      // ---------- FETCH ----------
      async function fetchDoctors() {
        const res = await fetch(API_DOCTORES);
        doctors = await res.json();
        doctorSelect.innerHTML = doctors
          .map(
            (d) =>
              `<option value="${d._id}">${d.firstName} ${d.lastName}</option>`,
          )
          .join("");
      }

      async function fetchTurnos() {
        const res = await fetch(API_TURNOS);
        turnos = await res.json();
        renderTurnos();
      }

      // ---------- RENDER ----------
      function renderTurnos() {
        if (window.innerWidth < 768) gridView = true;

        if (gridView) {
          tableContainer.classList.add("d-none");
          gridContainer.classList.remove("d-none");
          gridContainer.innerHTML = turnos.length
            ? turnos
                .map(
                  (t) => `
            <div class="col">
              <div class="card h-100 shadow-sm">
                <div class="card-body">
                  <h5 class="card-title">${t.doctor?.firstName} ${t.doctor?.lastName}</h5>
                  <p class="mb-1">Fecha/Hora: ${new Date(t.dateTime).toLocaleString()}</p>
                  <p class="mb-1">Duración: ${t.durationMinutes} min</p>
                  <p class="mb-1">Disponible: ${t.available ? "Sí" : "No"}</p>
                  <div class="d-flex justify-content-end gap-2 mt-2">
                    <button class="btn btn-sm btn-outline-primary editar-btn" data-id="${t._id}">Editar</button>
                    <button class="btn btn-sm btn-outline-danger eliminar-btn" data-id="${t._id}">Eliminar</button>
                  </div>
                </div>
              </div>
            </div>
          `,
                )
                .join("")
            : `<div class="text-muted">No hay turnos</div>`;
        } else {
          gridContainer.classList.add("d-none");
          tableContainer.classList.remove("d-none");
          tableBody.innerHTML = turnos.length
            ? turnos
                .map(
                  (t) => `
            <tr>
              <td>${t.doctor?.firstName} ${t.doctor?.lastName}</td>
              <td>${new Date(t.dateTime).toLocaleString()}</td>
              <td>${t.durationMinutes} min</td>
              <td>${t.available ? "Sí" : "No"}</td>
              <td>
                <button class="btn btn-sm btn-outline-primary editar-btn" data-id="${t._id}">Editar</button>
                <button class="btn btn-sm btn-outline-danger eliminar-btn" data-id="${t._id}">Eliminar</button>
              </td>
            </tr>
          `,
                )
                .join("")
            : `<tr><td colspan="5" class="text-center text-muted">No hay turnos</td></tr>`;
        }

        document.querySelectorAll(".editar-btn").forEach((btn) => {
          btn.addEventListener("click", () =>
            abrirModalEditar(turnos.find((t) => t._id === btn.dataset.id)),
          );
        });
        document.querySelectorAll(".eliminar-btn").forEach((btn) => {
          btn.addEventListener("click", async () => {
            if (!confirm("¿Eliminar turno?")) return;
            await fetch(API_TURNOS, {
              method: "DELETE",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ id: btn.dataset.id }),
            });
            await fetchTurnos();
          });
        });
      }

      // ---------- MODAL ----------
      btnNuevo.addEventListener("click", abrirModalNuevo);
      function abrirModalNuevo() {
        turnoEditando = null;
        document.getElementById("modalTitle").textContent = "Nuevo Turno";
        document.getElementById("turnoId").value = "";
        doctorSelect.value = doctors[0]?._id || "";
        document.getElementById("dateTime").value = "";
        document.getElementById("durationMinutes").value = 30;
        document.getElementById("available").checked = true;
        modal.show();
      }

      function abrirModalEditar(turno) {
        turnoEditando = turno;
        document.getElementById("modalTitle").textContent = "Editar Turno";
        document.getElementById("turnoId").value = turno._id;
        doctorSelect.value = turno.doctor?._id || "";
        document.getElementById("dateTime").value = new Date(turno.dateTime)
          .toISOString()
          .slice(0, 16);
        document.getElementById("durationMinutes").value =
          turno.durationMinutes;
        document.getElementById("available").checked = turno.available;
        modal.show();
      }

      // ---------- GUARDAR ----------
      guardarBtn.addEventListener("click", async () => {
        const data = {
          doctor: doctorSelect.value,
          dateTime: document.getElementById("dateTime").value,
          durationMinutes: Number(
            document.getElementById("durationMinutes").value,
          ),
          available: document.getElementById("available").checked,
        };
        try {
          let res;
          if (turnoEditando) {
            data.id = turnoEditando._id;
            res = await fetch(API_TURNOS, {
              method: "PATCH",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data),
            });
          } else {
            res = await fetch(API_TURNOS, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data),
            });
          }
          if (!res.ok) throw new Error("Error guardando turno");
          await fetchTurnos();
          modal.hide();
        } catch (err) {
          alert(err.message);
        }
      });

      // ---------- TOGGLE VISTA ----------
      btnToggleView.addEventListener("click", () => {
        gridView = !gridView;
        renderTurnos();
      });
      window.addEventListener("resize", () => {
        if (window.innerWidth < 768) gridView = true;
        renderTurnos();
      });

      // ---------- INIT ----------
      async function init() {
        await fetchDoctors();
        await fetchTurnos();
      }
      init();
    </script>
  </body>
</html>
