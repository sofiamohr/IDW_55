<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestión de Doctores</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .checkbox-group {
        max-height: 150px;
        overflow-y: auto;
        border: 1px solid #ddd;
        padding: 8px;
        border-radius: 4px;
      }
      .table-responsive {
        overflow-x: auto;
      }
    </style>
  </head>
  <body>
    <section>
      <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
          <a class="navbar-brand" href="main_menu.html">Mi Clínica</a>
          <button
            class="navbar-toggler"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#navbarNav"
            aria-controls="navbarNav"
            aria-expanded="false"
            aria-label="Toggle navigation"
          >
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
              <li class="nav-item">
                <a class="nav-link" href="doctors_menu.html">Doctores</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="health_insurances_menu.html"
                  >Obras sociales</a
                >
              </li>
              <li class="nav-item">
                <a class="nav-link" href="specialties_menu.html"
                  >Especialidades</a
                >
              </li>
              <li class="nav-item">
                <a class="nav-link" href="appointments_menu.html">Turnos</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="reservations_menu.html">Reservas</a>
              </li>
            </ul>
          </div>
        </div>
      </nav>
    </section>

    <div class="container py-4">
      <header
        class="d-flex justify-content-between align-items-center mb-4 flex-wrap"
      >
        <h1 class="mb-2 mb-md-0">Doctores</h1>
        <div class="d-flex gap-2 flex-wrap">
          <button id="btnNuevo" class="btn btn-primary">Nuevo Doctor</button>
          <button
            id="btnToggleView"
            class="btn btn-secondary d-none d-md-block"
          >
            Cambiar Vista
          </button>
        </div>
      </header>

      <!-- Grid de doctores -->
      <div id="gridContainer" class="row row-cols-1 row-cols-md-3 g-3"></div>

      <!-- Tabla de doctores -->
      <div id="tableContainer" class="table-responsive d-none">
        <table class="table table-striped table-bordered align-middle">
          <thead class="table-dark">
            <tr>
              <th>Nombre</th>
              <th>Matrícula</th>
              <th>Honorario</th>
              <th>Especialidades</th>
              <th>Obras Sociales</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="modalDoctor" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="modalTitle">Nuevo Doctor</h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Cerrar"
            ></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="doctorId" />
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Nombre</label>
                <input type="text" class="form-control" id="firstName" />
              </div>
              <div class="col-md-6">
                <label class="form-label">Apellido</label>
                <input type="text" class="form-control" id="lastName" />
              </div>
              <div class="col-md-6">
                <label class="form-label">Matrícula</label>
                <input type="number" class="form-control" id="licenseNumber" />
              </div>
              <div class="col-md-6">
                <label class="form-label">Honorario</label>
                <input
                  type="number"
                  class="form-control"
                  id="consultationFee"
                />
              </div>
              <div class="col-md-6">
                <label class="form-label">Teléfono</label>
                <input type="text" class="form-control" id="phone" />
              </div>
              <div class="col-md-6">
                <label class="form-label">Email</label>
                <input type="email" class="form-control" id="email" />
              </div>
              <div class="col-md-6">
                <label class="form-label">Especialidades</label>
                <div id="specialtiesContainer" class="checkbox-group"></div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Obras Sociales</label>
                <div
                  id="healthInsurancesContainer"
                  class="checkbox-group"
                ></div>
              </div>
              <div class="col-12">
                <label class="form-label">Descripción</label>
                <textarea
                  id="description"
                  class="form-control"
                  rows="2"
                ></textarea>
              </div>
              <div class="col-12">
                <label class="form-label">URL Imagen</label>
                <input type="text" id="image" class="form-control" />
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button type="button" class="btn btn-primary" id="guardarDoctor">
              Guardar
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const API_DOCTORS = "http://localhost:3000/api/doctors";
      const API_SPECIALTIES = "http://localhost:3000/api/specialties";
      const API_HEALTHINSURANCES = "http://localhost:3000/api/healthinsurances";

      const gridContainer = document.getElementById("gridContainer");
      const tableContainer = document.getElementById("tableContainer");
      const tableBody = document.getElementById("tableBody");
      const btnNuevo = document.getElementById("btnNuevo");
      const btnToggleView = document.getElementById("btnToggleView");
      const guardarBtn = document.getElementById("guardarDoctor");

      let doctors = [];
      let doctorEditando = null;
      let specialtiesList = [];
      let healthInsurancesList = [];
      let gridView = true; // true = grid, false = table

      // ---------- FETCH DATA ----------
      async function fetchSpecialties() {
        const res = await fetch(API_SPECIALTIES);
        specialtiesList = await res.json();
        const container = document.getElementById("specialtiesContainer");
        container.innerHTML = specialtiesList
          .map(
            (s) => `
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="specialty-${s._id}" value="${s._id}">
            <label class="form-check-label" for="specialty-${s._id}">${s.name}</label>
          </div>
        `,
          )
          .join("");
      }

      async function fetchHealthInsurances() {
        const res = await fetch(API_HEALTHINSURANCES);
        healthInsurancesList = await res.json();
        const container = document.getElementById("healthInsurancesContainer");
        container.innerHTML = healthInsurancesList
          .map(
            (h) => `
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="health-${h._id}" value="${h._id}">
            <label class="form-check-label" for="health-${h._id}">${h.name}</label>
          </div>
        `,
          )
          .join("");
      }

      async function fetchDoctors() {
        const res = await fetch(API_DOCTORS);
        doctors = await res.json();
        renderDoctors();
      }

      // ---------- RENDER ----------
      function renderDoctors() {
        if (window.innerWidth < 768) gridView = true;

        if (gridView) {
          tableContainer.classList.add("d-none");
          gridContainer.classList.remove("d-none");
          gridContainer.innerHTML = doctors.length
            ? doctors
                .map(
                  (d) => `
            <div class="col">
              <div class="card h-100 shadow-sm">
                <div class="card-body">
                  <h5 class="card-title">${d.firstName} ${d.lastName}</h5>
                  <p class="mb-1">Matrícula: ${d.licenseNumber}</p>
                  <p class="mb-1">Honorario: $${d.consultationFee}</p>
                  <p class="mb-1 text-muted">Especialidades: ${d.specialty.map((s) => s.name).join(", ") || "-"}</p>
                  <p class="mb-1 text-muted">Obras Sociales: ${d.healthInsurances.map((h) => h.name).join(", ") || "-"}</p>
                  <div class="d-flex justify-content-end gap-2 mt-2">
                    <button class="btn btn-sm btn-outline-primary editar-btn" data-id="${d._id}">Editar</button>
                    <button class="btn btn-sm btn-outline-danger eliminar-btn" data-id="${d._id}">Eliminar</button>
                  </div>
                </div>
              </div>
            </div>
          `,
                )
                .join("")
            : `<div class="text-muted">No hay doctores</div>`;
        } else {
          gridContainer.classList.add("d-none");
          tableContainer.classList.remove("d-none");
          tableBody.innerHTML = doctors.length
            ? doctors
                .map(
                  (d) => `
            <tr>
              <td>${d.firstName} ${d.lastName}</td>
              <td>${d.licenseNumber}</td>
              <td>$${d.consultationFee}</td>
              <td>${d.specialty.map((s) => s.name).join(", ") || "-"}</td>
              <td>${d.healthInsurances.map((h) => h.name).join(", ") || "-"}</td>
              <td>
                <button class="btn btn-sm btn-outline-primary editar-btn" data-id="${d._id}">Editar</button>
                <button class="btn btn-sm btn-outline-danger eliminar-btn" data-id="${d._id}">Eliminar</button>
              </td>
            </tr>
          `,
                )
                .join("")
            : `<tr><td colspan="6" class="text-center text-muted">No hay doctores</td></tr>`;
        }

        // Asignar eventos editar/eliminar
        document.querySelectorAll(".editar-btn").forEach((btn) => {
          btn.addEventListener("click", () =>
            abrirModalEditar(doctors.find((d) => d._id === btn.dataset.id)),
          );
        });
        document.querySelectorAll(".eliminar-btn").forEach((btn) => {
          btn.addEventListener("click", async () => {
            if (!confirm("¿Eliminar doctor?")) return;
            await fetch(API_DOCTORS, {
              method: "DELETE",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ id: btn.dataset.id }),
            });
            await fetchDoctors();
          });
        });
      }

      // ---------- MODAL ----------
      const modalElement = document.getElementById("modalDoctor");
      const modal = new bootstrap.Modal(modalElement);

      btnNuevo.addEventListener("click", abrirModalNuevo);

      function abrirModalNuevo() {
        doctorEditando = null;
        document.getElementById("modalTitle").textContent = "Nuevo Doctor";
        [
          "doctorId",
          "firstName",
          "lastName",
          "licenseNumber",
          "consultationFee",
          "phone",
          "email",
          "description",
          "image",
        ].forEach((id) => (document.getElementById(id).value = ""));
        specialtiesList.forEach(
          (s) =>
            (document.getElementById(`specialty-${s._id}`).checked = false),
        );
        healthInsurancesList.forEach(
          (h) => (document.getElementById(`health-${h._id}`).checked = false),
        );
        modal.show();
      }

      function abrirModalEditar(doctor) {
        doctorEditando = doctor;
        document.getElementById("modalTitle").textContent = "Editar Doctor";
        document.getElementById("doctorId").value = doctor._id;
        document.getElementById("firstName").value = doctor.firstName;
        document.getElementById("lastName").value = doctor.lastName;
        document.getElementById("licenseNumber").value = doctor.licenseNumber;
        document.getElementById("consultationFee").value =
          doctor.consultationFee;
        document.getElementById("phone").value = doctor.phone;
        document.getElementById("email").value = doctor.email;
        document.getElementById("description").value = doctor.description;
        document.getElementById("image").value = doctor.image;

        specialtiesList.forEach(
          (s) =>
            (document.getElementById(`specialty-${s._id}`).checked =
              doctor.specialty.some((x) => x._id === s._id)),
        );
        healthInsurancesList.forEach(
          (h) =>
            (document.getElementById(`health-${h._id}`).checked =
              doctor.healthInsurances.some((x) => x._id === h._id)),
        );

        modal.show();
      }

      // ---------- GUARDAR ----------
      guardarBtn.addEventListener("click", async () => {
        const doctorData = {
          firstName: document.getElementById("firstName").value.trim(),
          lastName: document.getElementById("lastName").value.trim(),
          licenseNumber: Number(document.getElementById("licenseNumber").value),
          consultationFee: Number(
            document.getElementById("consultationFee").value,
          ),
          phone: document.getElementById("phone").value.trim(),
          email: document.getElementById("email").value.trim(),
          description: document.getElementById("description").value.trim(),
          image: document.getElementById("image").value.trim(),
          specialty: specialtiesList
            .filter(
              (s) => document.getElementById(`specialty-${s._id}`).checked,
            )
            .map((s) => s._id),
          healthInsurances: healthInsurancesList
            .filter((h) => document.getElementById(`health-${h._id}`).checked)
            .map((h) => h._id),
        };

        try {
          let res;
          if (doctorEditando) {
            doctorData.id = doctorEditando._id;
            res = await fetch(API_DOCTORS, {
              method: "PATCH",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(doctorData),
            });
          } else {
            res = await fetch(API_DOCTORS, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(doctorData),
            });
          }
          if (!res.ok) throw new Error("Error guardando doctor");
          await fetchDoctors();
          modal.hide();
        } catch (err) {
          alert(err.message);
        }
      });

      // ---------- TOGGLE VISTA ----------
      btnToggleView.addEventListener("click", () => {
        gridView = !gridView;
        renderDoctors();
      });

      window.addEventListener("resize", () => {
        if (window.innerWidth < 768) gridView = true;
        renderDoctors();
      });

      // ---------- INIT ----------
      async function init() {
        await fetchSpecialties();
        await fetchHealthInsurances();
        await fetchDoctors();
      }
      init();
    </script>
  </body>
</html>
